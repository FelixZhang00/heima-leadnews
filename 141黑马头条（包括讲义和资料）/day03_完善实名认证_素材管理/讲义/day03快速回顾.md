**什么是分布式事务?**

```
在分布式架构中，一次业务调用  可能横跨多个服务  多个数据库，  传统的数据库事务无法保证数据的一致性，需要通过分布式事务来解决
```



**分布式事务理论基础?**

```
CAP定理:
	C   一致性
	A   可用性
	P   分区容错性
	结论:  分布式架构中 P一定存在，  三者只能满足其二
	      要么架构是 AP  可用性
	               CP  一致性
BASE理论: 
   BA  核心服务基本可用
   S   可能会出现数据的不一致(软状态)
   E   最终达成一致性
```



**分布式事务的解决方案?**

```

XA  :  基于XA接口的两阶段提交方案

AT  :  改良版的两阶段提交方案

TCC :  try  confirm   cancel

SAGA :  长事务解决方案    confirm   cancel

MQ + 本地消息表:  将一个大的事务，拆分成若干小的环节，通过可靠性的消息 来保证全部执行 

```

**Spring Cloud Alibaba Seata**

```
alibaba提供的一套开源框架，提供了分布式事务的一站式解决方案

支持:   XA   AT   TCC  SAGA
```



**如何使用seata?**

```
部署seata的服务端(TC 事务协调器)   
	修改配置 :  registry.conf 
					注册中心
					   让seata将自己的服务信息 注册到nacos中
					配置中心
						让seata从nacos中 拉取配置
	配置事务数据库:  
            全局事务表     分支事务表   全局锁表
微服务整合seata : 
	1. 引入seata的依赖   1.4.2 
	
	2. 修改微服务的配置   指定从nacos中  拉取seata服务端的信息
	
	3. 在事务的发起方法中 添加全局事务注解
	       @GlobalTransactional   
```



**seata的工作原理?**

```
使用前提:   1. 数据库必须是支持事务的关系型数据库

	      2.  必须是java项目，并且用JDBC去访问数据库
	      
	   
@GlobalTransactional  标记的方法说明开启了全局事务,seata会为该方法准备一个拦截器

当该方法被调用时，拦截器中 会向TC端 注册一个全局事务信息(xid)

注册好全局事务后，开始执行每个分支事务: 
	
	
		
	整理流程分为两个阶段;
	1. 执行 每一个分支事务
		seata为datasource创建了代理对象，每个服务中操作数据库的方法执行时会创建分支事务
	
		执行分支事务时:   
		seata会先解析要执行的sql语句   生成前置镜像  ==> 执行sql ==>  生成后置镜像 ,将镜像内容存入undolog日志中， 分支事务执行完毕
	
	
	2. 根据第一阶段结果，提交 或 回滚
	
		如果所有的分支事务都执行成功, 说明全局事务成功，异步的删除undolog日志即可
		
		
		如果有任何一个环节失败， 根据undolog日志进行事务回滚
		
				回滚时: 会判断当前数据内容和后置镜像是否一致，一致回滚
				                                      不一致，就一直重试
				                                      
```

**seata 是否会出现脏读问题?**

```
默认 会出现脏读，因为每个分支事务  真是的提交了数据库的事务

如果不想出现脏读，可以在select语句后加上for update,
    seata重写了语法解析，  会通过判断全局锁的方式   将隔离级别提升为  读已提交
    性能不好
```

**seata 是否会出现脏写问题?**

```
不会

虽然有脏读，但如果另一个事务拿到脏数据想修改，还是需要获取全局锁才可以
```



**seata能否保证高可用?**

```
可以通过搭建集群来解决


```

**实名认证模块**

```
ap_user   ap_user_realname (1, 2, 9)      user数据库    user微服务 (@Transactional )
                                                    @GlobalTransactional   

wm_user                                  wemedia数据库    wemedia微服务
 
ap_author                                  article数据库   article微服务

seata解决分布式事务问题
```

**AI实名认证方案**

```
用友云:     AI实名认证接口

身份证OCR接口:    扫描身份证信息  解析出身份证上的内容    识别姓名 和 身份证号   有效期

身份证二要素接口:    调用公安部接口，判断姓名 和 身份证号的真实性

活体检测接口:     根据上传的活体自拍照 ， 校验是否是真实的人脸自拍

人证核验接口:     判断活体检测 自拍照  和  身份证上的人像进行对比，得到一个score  如果大于85分

接口的调用:  
   1.  开通对应的接口服务  得到apicode
   
   2.  根据官方提供的接口文档使用RestTemplate调用即可
```

**阿里云OSS对象存储**

```
Object Storge Service  对象存储服务

头条项目中主要存储文章素材

1. 去阿里云官网开通OSS服务

2. 申请 accessKey   secret  秘钥

3. 结合官网提供的Java SDK 进行OSS调用

4. 封装统一依赖starter,将OSS的操作封装了一个接口 和 接口的实现 (FileStoreService)

5.  @Autowired FileStoreService  store(上传文件)   delete(删除文件)  downloadFile(下载文件)
```

**素材管理**

```
自媒体端    wm_material 素材表

上传素材:    将素材图片上传到OSS
           
           将图片路径  保存到 素材表中
查询素材列表: 

删除素材:

收藏素材: 
```

**网关整合小刀**

```
搭建聚合文档
```

